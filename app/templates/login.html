{% extends "base.html" %}

{% block title %}Login - Yorkie Bakery{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <h1>{{ "Register" if page_mode == "register" else "Login to Continue" }}</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            {% if page_mode == "register" %}
            Create an account to complete your checkout
            {% else %}
            Please login to complete your checkout
            {% endif %}
        </p>

        <form id="page-login-form" method="POST" action="/auth/login_form" data-mode="{{ page_mode or 'login' }}">
            <div id="page-login-error" style="display:none; margin-bottom:12px; color:#c0392b; font-weight:600;"></div>
            <div style="position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden;">
                <label>Leave this blank</label>
                <input type="text" name="register_contact" tabindex="-1" autocomplete="off">
            </div>
            <input type="hidden" name="register_started_at" id="page-register-started-at" value="">
            <div class="form-group" id="page-first-name-group" style="display:none;">
                <label for="page-first-name">First name:</label>
                <input type="text" id="page-first-name" name="first_name" placeholder="First name">
            </div>
            <div class="form-group" id="page-last-name-group" style="display:none;">
                <label for="page-last-name">Last name:</label>
                <input type="text" id="page-last-name" name="last_name" placeholder="Last name">
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required placeholder="Your email">
            </div>

            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" required placeholder="Your password">
            </div>

            <input type="hidden" name="redirect_url" value="{{ redirect_url }}">

            <button type="submit" class="btn btn-primary" id="page-submit-btn">Login</button>
        </form>

        <div style="text-align: center; margin: 20px 0;">
            <span style="color: #666;">or</span>
        </div>

        <!-- Social Login Buttons -->
        <button onclick="location.href='/auth/login/google'" class="social-btn google-btn" style="width: 100%; margin-bottom: 10px;" aria-label="Continue with Google">
            <span class="social-icon"><img src="/static/images/logo_google.jpg" alt=""></span>
            <span>Continue with Google</span>
        </button>
        <button onclick="location.href='/auth/login/facebook'" class="social-btn facebook-btn" style="width: 100%;" aria-label="Continue with Facebook">
            <span class="social-icon"><img src="/static/images/logo_fb.jpg" alt=""></span>
            <span>Continue with Facebook</span>
        </button>

        <div class="back-link" style="margin-top: 20px;">
            {% if page_mode == "register" %}
              <a href="/auth/login">Already have an account? Login</a>
            {% else %}
              <a href="/auth/register">Don't have an account? Register</a>
            {% endif %}
        </div>

        <div style="text-align: center; margin-top: 15px;">
            <a href="#" onclick="showForgotPassword()" style="font-size: 14px; color: #666; text-decoration: none;">Forgot Password?</a>
        </div>
    </div>
</div>

<!-- Forgot Password Modal -->
<div id="forgot-password-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 400px;">
        <h3 style="margin-top: 0;">Reset Password</h3>
        <p>Enter your email to receive a password reset link:</p>
        <input type="email" id="forgot-email" placeholder="Your email" style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px;">
        <div style="display: flex; gap: 10px;">
            <button onclick="sendResetLink()" class="btn btn-primary" style="flex: 1;">Send Reset Link</button>
            <button onclick="hideForgotPassword()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
        </div>
        <div id="reset-status" style="margin-top: 10px; font-size: 14px;"></div>
    </div>
</div>

<script>
function showForgotPassword() {
    document.getElementById('forgot-password-modal').style.display = 'block';
}

function hideForgotPassword() {
    document.getElementById('forgot-password-modal').style.display = 'none';
    document.getElementById('reset-status').textContent = '';
}

async function sendResetLink() {
    const email = document.getElementById('forgot-email').value;
    const statusEl = document.getElementById('reset-status');

    if (!email) {
        statusEl.textContent = 'Please enter your email';
        statusEl.style.color = 'red';
        return;
    }

    try {
        const response = await fetch('/auth/forgot_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email: email })
        });

        const result = await response.json();

        if (result.success) {
            statusEl.textContent = result.message;
            statusEl.style.color = 'green';
            setTimeout(() => {
                hideForgotPassword();
            }, 3000);
        } else {
            statusEl.textContent = result.error || 'Failed to send reset link';
            statusEl.style.color = 'red';
        }
    } catch (error) {
        statusEl.textContent = 'Error sending reset link';
        statusEl.style.color = 'red';
    }
}

// Close modal when clicking outside
document.getElementById('forgot-password-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideForgotPassword();
    }
});

// AJAX login to follow JSON redirect
const pageLoginForm = document.getElementById('page-login-form');
const pageLoginError = document.getElementById('page-login-error');
const pageFirst = document.getElementById('page-first-name-group');
const pageLast = document.getElementById('page-last-name-group');
const pageSubmitBtn = document.getElementById('page-submit-btn');
const pageRegisterStartedAt = document.getElementById('page-register-started-at');
if (pageLoginForm) {
    const mode = pageLoginForm.dataset.mode || "login";
    const isRegister = mode === "register";
    if (isRegister) {
        pageLoginForm.action = "/auth/register_form";
        if (pageFirst) pageFirst.style.display = "block";
        if (pageLast) pageLast.style.display = "block";
        if (pageSubmitBtn) pageSubmitBtn.textContent = "Register";
    }
    if (pageRegisterStartedAt) {
        pageRegisterStartedAt.value = Date.now() / 1000;
    }

    pageLoginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (pageLoginError) {
            pageLoginError.style.display = 'none';
            pageLoginError.textContent = '';
        }
        const formData = new FormData(pageLoginForm);
        try {
            const res = await fetch(pageLoginForm.action, { method: 'POST', body: formData });
            let data = null;
            try {
                data = await res.json();
            } catch (_err) {
                // Non-JSON response (e.g., unexpected redirect) -> graceful fallback
                pageLoginForm.submit();
                return;
            }
            if (data.redirect) {
                window.location.href = data.redirect;
                return;
            }
            if (!data.success) {
                if (pageLoginError) {
                    pageLoginError.textContent = data.error || (isRegister ? 'Registration failed' : 'Login failed');
                    pageLoginError.style.display = 'block';
                } else {
                    alert(data.error || (isRegister ? 'Registration failed' : 'Login failed'));
                }
                return;
            }
            // For register, prompt verification success and redirect
            if (isRegister) {
                pageLoginError.style.display = 'block';
                pageLoginError.style.color = 'green';
                pageLoginError.textContent = data.message || 'Registration successful. Check your email to verify your account.';
                setTimeout(() => {
                    window.location.href = "/auth/login";
                }, 800);
                return;
            }
            window.location.reload();
        } catch (err) {
            console.error('Auth failed', err);
            pageLoginForm.submit(); // fallback
        }
    });
}
</script>
{% endblock %}
