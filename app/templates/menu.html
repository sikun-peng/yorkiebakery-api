{% extends "base.html" %}

{% block title %}Menu Â· Yorkie Bakery{% endblock %}

{% block content %}
<h1>ğŸ½ï¸ Our Menu</h1>

{% set cart = request.session.get("cart", {}) %}

{# Group items by category #}
{% set categories = items | map(attribute='category') | unique | list %}

{# --- Mapping dictionaries --- #}
{% set origin_map = {
    "chinese": "ä¸­å›½",
    "french": "France",
    "american": "United States",
    "fusion": "Fusion",
    "korean": "í•œêµ­",
    "japanese": "æ—¥æœ¬",
    "italian": "Italia",
    "thai": "à¹„à¸—à¸¢",
    "germany": "Deutschland",
    "macau": "æ¾³é–€",
    "hong_kong": "é¦™æ¸¯"
} %}

{% set dietary_map = {
    "vegetarian": "ğŸ¥¬ Vegetarian",
    "vegan": "ğŸŒ± Vegan",
    "gluten_free": "âœ… Gluten-Free",
    "contains_gluten": "ğŸŒ¾ Contains Gluten",
    "contains_dairy": "ğŸ¥› Contains Dairy",
    "contains_nuts": "ğŸ¥œ Contains Nuts",
    "contains_pork": "ğŸ– Contains Pork",
    "contains_shellfish": "ğŸ¦ Contains Shellfish",
    "contains_alcohol": "ğŸ· Contains Alcohol",
    "spicy": "ğŸŒ¶ï¸ Spicy"
} %}

{% set category_map = {
    "pastry": "ğŸ° Pastry ğŸ˜‹ğŸ’– ",
    "dessert": "ğŸ¥® Dessert ğŸ®ğŸ¥",
    "entree": "ğŸ½ï¸ EntrÃ©e ğŸ‘¨â€ğŸ³",
    "drink": "ğŸ§‹ Drinks ğŸ˜ğŸ¹",
    "rice_and_noodles": "Rice ğŸš & Noodles ğŸœ ",
    "appetizer": "ğŸ¥Ÿ Appetizers ğŸ¥³ ",
    "soup": "ğŸ² Soup ğŸ¥£",
    "default": "ğŸ´ Other"
} %}

<!-- Dietary Filter -->
<div class="filter-shell">
  <details class="filter-section">
    <summary>
      <div class="filter-title">
        <span>ğŸ¥— Dietary filters</span>
      </div>
      <span class="filter-chevron">â–¼</span>
    </summary>

    <div class="filter-body">
      <form method="GET" action="/menu/view" class="filter-form">
          <div class="checkbox-group">
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="vegetarian">
                  <span>ğŸ¥¬ Vegetarian</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="vegan">
                  <span>ğŸŒ± Vegan</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="gluten_free">
                  <span>âœ… Gluten-Free</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_gluten">
                  <span>ğŸŒ¾ Contains Gluten</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_dairy">
                  <span>ğŸ¥› Contains Dairy</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_nuts">
                  <span>ğŸ¥œ Contains Nuts</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_pork">
                  <span>ğŸ– Contains Pork</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_shellfish">
                  <span>ğŸ¦ Contains Shellfish</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_alcohol">
                  <span>ğŸ· Contains Alcohol</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="spicy">
                  <span>ğŸŒ¶ï¸ Spicy</span>
              </label>
          </div>

          <div class="filter-actions">
              <button type="submit" class="btn filter-btn">Apply Filters</button>
              <a href="/menu/view" class="btn btn-outline clear-btn">Clear All</a>
          </div>
      </form>
    </div>
  </details>
</div>

{% for cat in categories %}
  <h2 class="category-header">
    {{ category_map[cat] if cat in category_map else cat|capitalize }}
  </h2>

  <div class="menu-grid">
    {% for item in items if item.category == cat %}
    <div class="menu-card">

      <!-- Image (clickable) -->
      <a href="/menu/item/{{ item.id }}" class="item-image-link">
        {% if item.image_url %}
          <img src="{{ item.image_url }}" alt="{{ item.title }}">
        {% else %}
          <img src="/static/images/default_menu_image.jpg" alt="No Image Available">
        {% endif %}
      </a>

      <!-- Title + Desc -->
      <h2><a href="/menu/item/{{ item.id }}" class="item-title-link">{{ item.title }}</a></h2>

      <!-- Reviews Summary -->
      {% set stats = review_stats.get(item.id|string, {"count": 0, "avg_rating": 0}) %}
      {% if stats.count > 0 %}
        <div class="review-summary">
          <span class="stars-small">{{ "â­" * stats.avg_rating|int }}</span>
          <span class="review-info">{{ stats.avg_rating }} ({{ stats.count }} review{{ "s" if stats.count != 1 else "" }})</span>
        </div>
      {% else %}
        <div class="review-summary">
          <a href="/menu/item/{{ item.id }}" class="no-reviews-link">No reviews yet - Be the first!</a>
        </div>
      {% endif %}

      <p class="item-description">{{ item.description }}</p>

      <!-- Metadata row -->
      <div class="menu-meta">

        {% if item.origin %}
        <p><strong>Origin:</strong>
          {{ origin_map[item.origin] if item.origin in origin_map else item.origin }}
        </p>
        {% endif %}

        {% if item.tags %}
        <p><strong>Tags:</strong> {{ item.tags | join(", ") }}</p>
        {% endif %}

        {% if item.flavor_profiles %}
        <p><strong>Flavor:</strong> {{ item.flavor_profiles | join(", ") }}</p>
        {% endif %}

        {% if item.dietary_features %}
            {% set mapped = [] %}

            {% for d in item.dietary_features %}
                {% if d in dietary_map %}
                    {% set _ = mapped.append(dietary_map[d]) %}
                {% else %}
                    {% set _ = mapped.append(d) %}
                {% endif %}
            {% endfor %}

            <p><strong>Dietary:</strong> {{ mapped | join(", ") }}</p>
        {% endif %}

      </div>

      <!-- Price -->
      {% if item.price is not none %}
        <p class="price">${{ "%.2f"|format(item.price) }}</p>
      {% else %}
        <p class="price text-gray-400 italic">Price not set</p>
      {% endif %}

      <!-- Quantity in session -->
      {% set qty = cart.get(item.id|string, 0) %}

      {% if qty > 0 %}
        <span class="item-qty-badge">{{ qty }}</span>
      {% endif %}

      {% if qty == 0 %}
        <form action="/cart/add/{{ item.id }}" method="post" class="cart-form" data-cart-action="add" data-item-id="{{ item.id }}">
          <button type="submit" class="btn">Add to Cart ğŸ›ï¸</button>
        </form>
      {% else %}
        <div class="qty-controls">

          <form action="/cart/remove/{{ item.id }}" method="post" class="cart-form" data-cart-action="remove" data-item-id="{{ item.id }}" style="display:inline;">
            <button type="submit" class="qty-btn" {% if qty == 0 %}disabled{% endif %}>âˆ’</button>
          </form>

          <span class="qty-display">{{ qty }}</span>

          <form action="/cart/add/{{ item.id }}" method="post" class="cart-form" data-cart-action="add" data-item-id="{{ item.id }}" style="display:inline;">
            <button type="submit" class="qty-btn">+</button>
          </form>

        </div>
      {% endif %}

    </div>
    {% endfor %}
  </div>

{% endfor %}

{% endblock %}
