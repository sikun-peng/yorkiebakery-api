{% extends "base.html" %}

{% block title %}Menu Â· Yorkie Bakery{% endblock %}

{% block content %}
<h1 class="cute-title rainbow-text" style="text-align:center;">ğŸ½ï¸ğŸ Oscar's Menu ğŸ’ğŸ´</h1>

{% set cart = request.session.get("cart", {}) %}

{# Group items by category #}
{% set categories = items | map(attribute='category') | unique | list %}

{# --- Mapping dictionaries --- #}
{% set origin_map = {
    "fusion": "Fusion âœ¨ğŸ±ğŸ¥—",
    "french": "la France ğŸ“ğŸ¥–ğŸ¥ğŸ®",
    "italian": "Italia ğŸğŸ§€ğŸ°",
    "germany": "Deutschland ğŸºğŸ¥¨ğŸ’",
    "american": "U.S. ğŸ•ğŸ”ğŸŸğŸ¥¤ ",
    "mexican": "MÃ©xico ğŸŒ¶ï¸ğŸŒ®ğŸŒ¯",
    "chinese": "ä¸­å›½ ğŸšğŸ¥¢ğŸ¥ŸğŸ¥ ",
    "korean": "í•œêµ­ ğŸŒ¶ï¸ğŸœğŸğŸ² ",
    "japanese": "ã«ã»ã‚“ ğŸ£ğŸ±ğŸ™ğŸ¥",
    "vietnamese": "Viá»‡t Nam ğŸœğŸŒ¿ğŸ²",
    "thai": "à¹„à¸—à¸¢ ğŸ¥˜ğŸ¤ğŸ¥¥",
    "macau": "æ¾³é–€ ğŸ®ğŸŒº",
    "hong_kong": "é¦™æ¸¯ ğŸ¥ŸğŸ¤",
    "taiwanese": "å°ç£ ğŸ§‹ğŸğŸ¥¢",
} %}

{% set dietary_map = {
    "vegetarian": "ğŸ¥¦ Vegetarian",
    "vegan": "ğŸ¥• Vegan",
    "gluten_free": "âœ… Gluten-Free",
    "contains_gluten": "ğŸŒ¾ Contains Gluten",
    "contains_dairy": "ğŸ§€ Contains Dairy",
    "contains_nuts": "ğŸ¥œ Contains Nuts",
    "contains_pork": "ğŸ· Contains Pork",
    "contains_shellfish": "ğŸ¦ Contains Shellfish",
    "contains_alcohol": "ğŸ· Contains Alcohol",
    "spicy": "ğŸŒ¶ï¸ Spicy"
} %}

{% set category_map = {
    "pastry": "ğŸ° Pastry ğŸ˜‹ğŸ’– ",
    "dessert": "ğŸ¥® Dessert ğŸ®ğŸ¥",
    "entree": "ğŸ½ï¸ EntrÃ©e ğŸ‘¨â€ğŸ³",
    "drink": "ğŸ§‹ Drinks ğŸ˜ğŸ¹",
    "rice_and_noodles": "Rice ğŸš & Noodles ğŸœ ",
    "appetizer": "ğŸ¥Ÿ Appetizers ğŸ¥³ ",
    "soup": "ğŸ² Soup ğŸ¥£",
    "default": "ğŸ´ Other"
} %}

<!-- Dietary Filter -->
<div class="filter-shell">
  <details class="filter-section">
    <summary>
      <div class="filter-title">
        <span>ğŸ¥— Dietary filters</span>
      </div>
      <span class="filter-chevron">â–¼</span>
    </summary>

    <div class="filter-body">
      <form method="GET" action="/menu/view" class="filter-form">
          <div class="checkbox-group">
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="vegetarian">
                  <span>ğŸ¥¦ Vegetarian</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="vegan">
                  <span>ğŸ¥• Vegan</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="gluten_free">
                  <span>âœ… Gluten-Free</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_gluten">
                  <span>ğŸŒ¾ Contains Gluten</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_dairy">
                  <span>ğŸ§€ Contains Dairy</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_nuts">
                  <span>ğŸ¥œ Contains Nuts</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_pork">
                  <span>ğŸ· Contains Pork</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_shellfish">
                  <span>ğŸ¦ Contains Shellfish</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="contains_alcohol">
                  <span>ğŸ· Contains Alcohol</span>
              </label>
              <label class="checkbox-label">
                  <input type="checkbox" name="dietary" value="spicy">
                  <span>ğŸŒ¶ï¸ Spicy</span>
              </label>
          </div>

          <div class="filter-actions">
              <button type="submit" class="btn filter-btn">Apply Filters</button>
              <a href="/menu/view" class="btn btn-outline clear-btn">Clear All</a>
          </div>
      </form>
    </div>
  </details>
</div>

{% for cat in categories %}
  <div class="menu-category-block">
    <h2 class="category-header cute-title">
      {{ category_map[cat] if cat in category_map else cat|capitalize }}
    </h2>

    <div class="menu-grid">
      {% for item in items if item.category == cat %}
      <div class="menu-card" data-item-link="/menu/item/{{ item.id }}" role="link" tabindex="0">

      {% set stats = review_stats.get(item.id|string, {"count": 0, "avg_rating": 0}) %}

      <!-- Image (clickable) -->
      <div class="item-image-link" style="position:relative;">
        {% if item.image_url %}
          <img src="{{ item.image_url }}" alt="{{ item.title }}">
        {% else %}
          <img src="/static/images/default_menu_image.jpg" alt="No Image Available">
        {% endif %}
        {% if (stats and stats.avg_rating and stats.count) or (item.tags and ('chef special' in item.tags)) %}
          <div style="position:absolute; top:8px; left:8px; display:flex; gap:6px; flex-wrap:wrap;">
            {% if stats and stats.avg_rating and stats.count %}
              {% if stats.avg_rating >= 4.8 and stats.count > 5 %}
                <span style="display:inline-flex; align-items:center; gap:6px; font-size:13px; font-weight:700; color:#d35400; background:#ffe9d6; padding:4px 8px; border-radius:999px;">
                  ğŸ”¥ Most Popular
                </span>
              {% elif stats.count > 3 %}
                <span style="display:inline-flex; align-items:center; gap:6px; font-size:13px; font-weight:700; color:#8a5a00; background:#fff3d9; padding:4px 8px; border-radius:999px;">
                  âœ¨ Trending Now
                </span>
              {% endif %}
            {% endif %}
            {% if item.tags and ('chef special' in item.tags) %}
              <span style="display:inline-flex; align-items:center; gap:6px; font-size:13px; font-weight:700; color:#9c27b0; background:#f5e9ff; padding:4px 8px; border-radius:999px;">
                ğŸ‘¨â€ğŸ³ Chef Special
              </span>
            {% endif %}
          </div>
        {% endif %}
      </div>

      <!-- Title + Desc -->
      <h2 class="item-title-link cute-subtitle">{{ item.title }}</h2>

      <!-- Reviews Summary -->
      {% if stats.count > 0 %}
        <div class="review-summary">
          <span class="stars-small">{{ "â­" * stats.avg_rating|int }}</span>
          <span class="review-info">{{ stats.avg_rating }} ({{ stats.count }} review{{ "s" if stats.count != 1 else "" }})</span>
        </div>
      {% else %}
        <div class="review-summary">
          <a href="/menu/item/{{ item.id }}" class="no-reviews-link">No reviews yet - Be the first!</a>
        </div>
      {% endif %}

      <p class="item-description">{{ item.description }}</p>

      <!-- Metadata row -->
      <div class="menu-meta">

        {% if item.origin %}
        <p><strong>Origin:</strong>
          {{ origin_map[item.origin] if item.origin in origin_map else item.origin }}
        </p>
        {% endif %}

        {% if item.tags %}
        <p><strong>Tags:</strong> {{ item.tags | join(", ") }}</p>
        {% endif %}

        {% if item.flavor_profiles %}
        <p><strong>Flavor:</strong> {{ item.flavor_profiles | join(", ") }}</p>
        {% endif %}

        {% if item.dietary_features %}
            {% set mapped = [] %}

            {% for d in item.dietary_features %}
                {% if d in dietary_map %}
                    {% set _ = mapped.append(dietary_map[d]) %}
                {% else %}
                    {% set _ = mapped.append(d) %}
                {% endif %}
            {% endfor %}

            <p><strong>Dietary:</strong> {{ mapped | join(", ") }}</p>
        {% endif %}

      </div>

      <!-- Price -->
      {% if item.price is not none %}
        <p class="price">
          <span class="old-price">${{ "%.0f"|format(item.price) }}</span>
          <span class="free-pill">Free</span>
        </p>
      {% else %}
        <p class="price text-gray-400 italic">Price not set</p>
      {% endif %}

      <!-- Quantity in session -->
      {% set qty = cart.get(item.id|string, 0) %}

      {% if qty > 0 %}
        <span class="item-qty-badge">{{ qty }}</span>
      {% endif %}

      {% if qty == 0 %}
        <form action="/cart/add/{{ item.id }}" method="post" class="cart-form" data-cart-action="add" data-item-id="{{ item.id }}">
          <button type="submit" class="btn">Add to Cart ğŸ›ï¸</button>
        </form>
      {% else %}
        <div class="qty-controls">

          <form action="/cart/remove/{{ item.id }}" method="post" class="cart-form" data-cart-action="remove" data-item-id="{{ item.id }}" style="display:inline;">
            <button type="submit" class="qty-btn" {% if qty == 0 %}disabled{% endif %}>âˆ’</button>
          </form>

          <span class="qty-display">{{ qty }}</span>

          <form action="/cart/add/{{ item.id }}" method="post" class="cart-form" data-cart-action="add" data-item-id="{{ item.id }}" style="display:inline;">
            <button type="submit" class="qty-btn">+</button>
          </form>

        </div>
      {% endif %}

      </div>
      {% endfor %}
    </div>
  </div>

{% endfor %}

<!-- ğŸ¤ Sponsors -->
<div class="sponsor-strip">
  <div class="sponsor-strip-inner">
    <p class="sponsor-label">Proudly Sponsored By</p>
    <div class="sponsor-badges">
      <img src="/static/images/logo_juilliard.jpg" alt="Juilliard">
      <img src="/static/images/logo_bpo.jpg" alt="BPO">
      <img src="/static/images/logo_yamaha.jpg" alt="Yamaha">
      <img src="/static/images/logo_cliburn.jpg" alt="Cliburn">
      <img src="/static/images/logo_bucees.jpg" alt="Buc-ee's">
      <img src="/static/images/logo_heb.jpg" alt="H-E-B">
      <img src="/static/images/logo_in_n_out.jpg" alt="In-N-Out">
      <img src="/static/images/logo_white.jpg" alt="Yorkie Bakery">
    </div>
  </div>
</div>

{% endblock %}
