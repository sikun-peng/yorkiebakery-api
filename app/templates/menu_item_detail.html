{% extends "base.html" %}

{% block title %}{{ item.title }} ¬∑ Yorkie Bakery{% endblock %}

{% block content %}
{% set cart = request.session.get("cart", {}) %}
{% set qty = cart.get(item.id|string, 0) %}
{% set images = ([item.image_url] if item.image_url else []) + (item.gallery_urls or []) %}
{% set primary_image = images[0] if images else "/static/images/default_menu_image.jpg" %}
<style>
    .gallery-thumbs {
        display: flex;
        gap: 10px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    .thumb-btn {
        border: 1px solid #eee;
        padding: 2px;
        background: #fafafa;
        border-radius: 6px;
        cursor: pointer;
    }
    .thumb-btn:focus { outline: 2px solid #d9bfa9; }
    .thumb-img {
        height: 70px;
        width: 70px;
        object-fit: cover;
        border-radius: 4px;
        display: block;
    }
    .recipe-card {
        margin-top: 16px;
        padding: 14px 16px;
        background: #faf7f2;
        border: 1px solid #e7dbcf;
        border-radius: 8px;
        white-space: pre-wrap;
        line-height: 1.6;
        font-family: "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 14px;
    }
    .recipe-card h3 {
        margin-top: 0;
        margin-bottom: 8px;
        font-family: inherit;
    }
</style>
<div class="menu-item-detail">
    <a href="/menu/view" class="back-link">‚Üê Back to Menu</a>

    <div class="item-container">
        <!-- Left: Image and Basic Info -->
        <div class="item-main">
            <img src="{{ primary_image }}" alt="{{ item.title }}" class="item-image main-image">

            {% if images|length > 1 %}
                <div class="gallery-thumbs">
                    {% for img in images %}
                        <button type="button" class="thumb-btn" data-full="{{ img }}">
                            <img src="{{ img }}" alt="{{ item.title }} thumbnail {{ loop.index }}" class="thumb-img">
                        </button>
                    {% endfor %}
                </div>
            {% endif %}

            <h1>{{ item.title }}</h1>

            {% if avg_rating > 0 %}
                <div class="rating-summary">
                    <span class="stars">{{ "‚≠ê" * avg_rating|int }}</span>
                    <span class="rating-text">{{ avg_rating }} / 5</span>
                    <span class="review-count">({{ review_count }} reviews)</span>
                </div>
            {% else %}
                <p class="no-reviews">No reviews yet</p>
            {% endif %}

            <p class="item-description">{{ item.description }}</p>

            <div class="item-meta">
                {% if item.origin %}
                    <p><strong>Origin:</strong> {{ item.origin|capitalize }}</p>
                {% endif %}

                {% if item.category %}
                    <p><strong>Category:</strong> {{ item.category|capitalize }}</p>
                {% endif %}

                {% if item.tags %}
                    <p><strong>Tags:</strong> {{ item.tags | join(", ") }}</p>
                {% endif %}

            {% if item.flavor_profiles %}
                <p><strong>Flavor:</strong> {{ item.flavor_profiles | join(", ") }}</p>
            {% endif %}

            {% if item.dietary_features %}
                    <p><strong>Dietary:</strong> {{ item.dietary_features | join(", ") }}</p>
                {% endif %}
            </div>

            {% if item.price is not none %}
                <p class="price">
                    <span class="old-price">${{ "%.2f"|format(item.price) }}</span>
                    <span class="free-pill">Free</span>
                </p>
            {% endif %}

            {% if item.recipe %}
                <div class="recipe-card">
                    <h3>Recipe / Notes</h3>
                    {{ item.recipe }}
                </div>
            {% endif %}

            {% if request.session.get("user") and request.session.get("user").get("is_admin") %}
            <div style="margin-top:16px; padding:14px; border:1px solid var(--border); border-radius:10px; background:#fff;">
                <h4 style="margin-top:0;">Admin: Update Recipe & Gallery</h4>
                <form id="admin-update-form"
                      enctype="multipart/form-data"
                      method="post"
                      action="/menu/{{ item.id }}">
                    <label style="display:block; margin-bottom:6px;">Recipe / Notes</label>
                    <textarea name="recipe" rows="3" style="width:100%; padding:8px; border:1px solid var(--border); border-radius:8px; margin-bottom:10px;">{{ item.recipe or "" }}</textarea>

                    <label style="display:block; margin-bottom:6px;">Add Gallery Images</label>
                    <input type="file" name="images" accept="image/*" multiple style="margin-bottom:10px;">

                    <button type="submit" class="btn btn-outline">Save</button>
                    <span id="admin-update-status" style="margin-left:10px; font-size:12px; color: var(--text-light);"></span>
                </form>
            </div>
            {% endif %}

            <!-- Add to Cart -->
            {% if qty == 0 %}
              <form action="/cart/add/{{ item.id }}" method="post" class="cart-form" data-cart-action="add" data-item-id="{{ item.id }}">
                  <button type="submit" class="btn btn-primary">Add to Cart üõçÔ∏è</button>
              </form>
            {% else %}
              <div class="qty-controls">
                  <form action="/cart/remove/{{ item.id }}" method="post" class="cart-form" data-cart-action="remove" data-item-id="{{ item.id }}" style="display:inline;">
                      <button type="submit" class="qty-btn" {% if qty == 0 %}disabled{% endif %}>‚àí</button>
                  </form>

                  <span class="qty-display">{{ qty }}</span>

                  <form action="/cart/add/{{ item.id }}" method="post" class="cart-form" data-cart-action="add" data-item-id="{{ item.id }}" style="display:inline;">
                      <button type="submit" class="qty-btn">+</button>
                  </form>
              </div>
            {% endif %}
        </div>

        <!-- Right: Reviews Section -->
        <div class="reviews-section">
            <h2>Reviews</h2>

            {% if user %}
                <!-- Review Form (only for logged-in users) -->
                <div class="review-form">
                    <h3>Write a Review</h3>
                    <form action="/reviews/create" method="post">
                        <input type="hidden" name="menu_item_id" value="{{ item.id }}">

                        <div class="form-group">
                            <label for="rating">Rating:</label>
                            <select name="rating" id="rating" required>
                                <option value="">Select rating</option>
                                <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (5/5)</option>
                                <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê (4/5)</option>
                                <option value="3">‚≠ê‚≠ê‚≠ê (3/5)</option>
                                <option value="2">‚≠ê‚≠ê (2/5)</option>
                                <option value="1">‚≠ê (1/5)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="comment">Your Review:</label>
                            <textarea name="comment" id="comment" rows="4" required placeholder="Share your experience..."></textarea>
                        </div>

                        <button type="submit" class="btn btn-submit">Submit Review</button>
                    </form>
                </div>
            {% else %}
                <p class="login-prompt">
                    <a href="/auth/login?redirect_url=/menu/item/{{ item.id }}">Log in</a> to write a review
                </p>
            {% endif %}

            <!-- Display Reviews -->
            <div class="reviews-list">
                {% if reviews %}
                    {% for review in reviews %}
                        <div class="review-card">
                            <div class="review-header">
                                <span class="review-author">{{ review.user_name }}</span>
                                <span class="review-date">{{ review.created_at.strftime('%B %d, %Y') }}</span>
                            </div>
                            <div class="review-rating">
                                {{ "‚≠ê" * review.rating }}
                            </div>
                            <p class="review-comment">{{ review.comment }}</p>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="no-reviews">No reviews yet. Be the first to review!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<script>
    const mainImg = document.querySelector(".main-image");
    const thumbs = document.querySelectorAll(".thumb-btn");
    thumbs.forEach(btn => {
        btn.addEventListener("click", () => {
            mainImg.src = btn.dataset.full;
        });
    });

    // Admin update form (recipe + gallery)
    const adminForm = document.getElementById("admin-update-form");
    if (adminForm) {
        adminForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const statusEl = document.getElementById("admin-update-status");
            statusEl.textContent = "Saving...";
            const fd = new FormData();
            const recipe = adminForm.querySelector('textarea[name="recipe"]').value || "";
            fd.append("recipe", recipe);
            const files = adminForm.querySelector('input[name=\"images\"]').files;
            for (let i = 0; i < files.length; i++) {
                fd.append("images", files[i]);
            }
            try {
                const res = await fetch("/menu/{{ item.id }}", {
                    method: "PUT",
                    body: fd,
                });
                if (!res.ok) throw new Error("Save failed");
                statusEl.textContent = "Saved!";
                window.location.reload();
            } catch (err) {
                statusEl.textContent = "Error saving";
                console.error(err);
            }
        });
    }
</script>
{% endblock %}
